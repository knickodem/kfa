---
output:
   html_document:
      toc: TRUE
      toc_depth: 2
      always_allow_html: TRUE
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE)
# knitr::opts_chunk$set(options(knitr.kable.NA = ''))

```

---
title: "`r report.title`"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
---

# Analysis Summary

**# of folds:** `r k`

**# of variables:** `r nvars`

**# of observations:** `r nobs`

**Maximum # of factors extracted:** `r maxfac`

**RMSEA across folds by factor model**

```{r lowmod, ft.align = "left", results='asis'}
aggfit.flex <- flextable::flextable(aggfit)
aggfit.flex <- colformat_num(aggfit.flex, j = 2:4, digits = 2)
aggfit.flex <- flextable::align(aggfit.flex, align = "center", part = "all")
aggfit.flex <- flextable::set_header_labels(aggfit.flex, low_in_fold = "lowest in fold")
aggfit.flex <- flextable::autofit(aggfit.flex)
knit_print(aggfit.flex)
```



# Model Fit Summary

```{r fits, ft.align = "left", results='asis'}
for(f in 1:length(kfits)){
  
  cat("### Fold", f)
  cat("\n\n")
  fit.flex <- flextab_format(kfits[[f]], bold.type = "rmsea", digits = 2)
  cat(knit_print(fit.flex))
  cat("\n\n")
  
}
  
```


# Model Structure

```{r structure, ft.align = "left", results = 'asis', fig.height = 4}

for(m in 1:maxfac){
  cat("## Factors:", m)
  cat("\n\n")
  cat("### Standardized Loading Across Folds")
  cat("\n\n")
  lambda.flex <- flextab_format(klambdas[[m]], bold.type = "lambda",
                                cut = cut, digits = 2)
  cat(knit_print(lambda.flex))
  cat("\n\n")
  if(m > 1){
  cat("### Mean Factor Correlations")
  cat("\n\n")
  corr.flex <- flextab_format(kcorrs[[m]], bold.type = "none", digits = 2)
  corr.flex <- compose(corr.flex, i = 1, j = 1, value = as_paragraph(""), part = "header")
  cat(knit_print(corr.flex))
  cat("\n\n")
  }
  for(s in seq_along(kstructures[[m]])){
    cat("### Factor Structure", s)
    cat("\n\n")
    cat("**In Folds:", paste(kstructures[[m]][[s]]$folds, collapse = ", "), "**")
    cat("\n\n")
    cat(gsub("\n", "\n\n", kstructures[[m]][[s]]$structure))
    cat("\n\n")
    for(f in kstructures[[m]][[s]]$folds){
    cat("#### Fold", f)
    cat("\n\n")
    # do.call(semPlot::semPaths, args = c(list(object = kfa[[f]][[m]]), plot.settings))
    semPlot::semPaths(kfa[[f]][[m]], what = "std", whatLabels = "no", layout = "tree",
                        intercepts = FALSE, residuals = FALSE, thresholds = FALSE,
                        color = list(lat = palette.colors(n = m + 1, palette = "Okabe-Ito",
                                                          recycle = TRUE)[-1]),
                        cut = cut, posCol = c("#BF0000","#000000"), fade = FALSE,
                        # edge.color = , # could create custom function to utilize this argument
                        weighted = TRUE, negDashed = TRUE, esize = 5,
                        manifests = vnames, reorder = FALSE)
      cat("\n\n")
  }
 }
}

```

