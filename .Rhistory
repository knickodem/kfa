roxygen2::roxygenise()
#### Import data ####
shortfile <- c("C:/Users/kylenick/University of North Carolina at Chapel Hill/Halpin, Peter Francis - UNC_stat_projets/EFA&CFA/")
student <- read.csv(paste0(shortfile, "scaledim/student_survey-latest.csv"))
teacher <- read.csv(paste0(shortfile, "scaledim/teacher_survey-latest.csv"))
principal <- read.csv(paste0(shortfile, "scaledim/principal_survey-latest.csv"))
coach <- read.csv(paste0(shortfile, "scaledim/coach_survey-latest.csv"))
## item map
itemmaps <- lapply(c("Coach_survey", "Teacher Survey",
"Principal Survey", "Student Survey"), function(x){
readxl::read_excel(paste0(shortfile, "Item construct map_2020_10_25.xlsx"),
sheet = x)})
names(itemmaps) <- c("coach", "teacher", "principal", "student")
## items for analysis
studentdf <- student[ ,names(student) %in% na.omit(itemmaps$student$`Variable Name`)]
teacherdf <- teacher[ ,names(teacher) %in% na.omit(itemmaps$teacher$`Variable Name`)]
principaldf <- principal[ ,names(principal) %in% na.omit(itemmaps$principal$`Variable Name`)]
coachdf <- coach[ ,names(coach) %in% na.omit(itemmaps$coach$`Variable Name`)]
## custom factor structure (just an example, not based on theory)
custom2 <- paste0("f1 =~ ", paste(names(studentdf)[1:10], collapse = " + "),
"\nf2 =~ ",paste(names(studentdf)[11:21], collapse = " + "))
custom3 <- paste0("f1 =~ ", paste(names(studentdf)[1:2], collapse = " + "),
"\nf2 =~ ",paste(names(studentdf)[3:4], collapse = " + "),
"\nf3 =~ ",paste(names(studentdf)[5:6], collapse = " + "),
"\nf4 =~ ",paste(names(studentdf)[7:8], collapse = " + "),
"\nf5 =~ ",paste(names(studentdf)[9:10], collapse = " + "),
"\nf6 =~ ",paste(names(studentdf)[11:12], collapse = " + "),
"\nf7 =~ ",paste(names(studentdf)[13:21], collapse = " + "),
"\na1101x ~~ ", paste(names(studentdf)[2:21], collapse = " + "),
"\na1102x ~~ ", paste(names(studentdf)[3:21], collapse = " + "))
set.seed(936639) # set seed to reproduce same folds
kstudent <- kfa(variables = studentdf,
k = NULL,
m = 5,
custom.cfas = list(`Custom 2f` = custom2, Break = custom3),
rotation = "oblimin",
ordered = TRUE,
estimator = "DWLS",
missing = "pairwise")
unlink("C:/Users/kylenick/Documents/R/win-library/4.0/00LOCK-kfa", recursive = TRUE)
library(kfa)
library(kfa)
###################################
#                                 #
#        kfa package tests        #
#                                 #
###################################
#### Import data ####
shortfile <- c("C:/Users/kylenick/University of North Carolina at Chapel Hill/Halpin, Peter Francis - UNC_stat_projets/EFA&CFA/")
student <- read.csv(paste0(shortfile, "scaledim/student_survey-latest.csv"))
teacher <- read.csv(paste0(shortfile, "scaledim/teacher_survey-latest.csv"))
principal <- read.csv(paste0(shortfile, "scaledim/principal_survey-latest.csv"))
coach <- read.csv(paste0(shortfile, "scaledim/coach_survey-latest.csv"))
## item map
itemmaps <- lapply(c("Coach_survey", "Teacher Survey",
"Principal Survey", "Student Survey"), function(x){
readxl::read_excel(paste0(shortfile, "Item construct map_2020_10_25.xlsx"),
sheet = x)})
names(itemmaps) <- c("coach", "teacher", "principal", "student")
## items for analysis
studentdf <- student[ ,names(student) %in% na.omit(itemmaps$student$`Variable Name`)]
teacherdf <- teacher[ ,names(teacher) %in% na.omit(itemmaps$teacher$`Variable Name`)]
principaldf <- principal[ ,names(principal) %in% na.omit(itemmaps$principal$`Variable Name`)]
coachdf <- coach[ ,names(coach) %in% na.omit(itemmaps$coach$`Variable Name`)]
# ---- test full kfold_fa function ----------------
## custom factor structure (just an example, not based on theory)
custom2 <- paste0("f1 =~ ", paste(names(studentdf)[1:10], collapse = " + "),
"\nf2 =~ ",paste(names(studentdf)[11:21], collapse = " + "))
custom3 <- paste0("f1 =~ ", paste(names(studentdf)[1:2], collapse = " + "),
"\nf2 =~ ",paste(names(studentdf)[3:4], collapse = " + "),
"\nf3 =~ ",paste(names(studentdf)[5:6], collapse = " + "),
"\nf4 =~ ",paste(names(studentdf)[7:8], collapse = " + "),
"\nf5 =~ ",paste(names(studentdf)[9:10], collapse = " + "),
"\nf6 =~ ",paste(names(studentdf)[11:12], collapse = " + "),
"\nf7 =~ ",paste(names(studentdf)[13:21], collapse = " + "),
"\na1101x ~~ ", paste(names(studentdf)[2:21], collapse = " + "),
"\na1102x ~~ ", paste(names(studentdf)[3:21], collapse = " + "))
temp <- run_efa(studentdf,
m = 5,
ordered = TRUE,
missing = "pairwise")
temp <- run_efa(studentdf,
m = 2,
ordered = TRUE,
missing = "pairwise")
## calculate and extract sample statistics
sampstats <- lavaan::lavCor(object = studentdf,
ordered = names(studentdf),
estimator = "DWLS",
missing = 'pairwise',
output = "fit",
cor.smooth = FALSE)
sample.nobs <- lavaan::lavInspect(sampstats, "nobs")
sample.cov <- lavaan::lavInspect(sampstats, "sampstat")$cov
sample.mean <- lavaan::lavInspect(sampstats, "sampstat")$mean
sample.th <- lavaan::lavInspect(sampstats, "sampstat")$th
attr(sample.th, "th.idx") <- lavaan::lavInspect(sampstats, "th.idx")
WLS.V <- lavaan::lavInspect(sampstats, "wls.v")
NACOV <- lavaan::lavInspect(sampstats, "gamma")
## write efa syntax
efa.mod <- write_efa(nf = 2, vnames = names(studentdf))
unrotated <- lavaan::cfa(model = efa.mod,
sample.cov = sample.cov,
sample.nobs = sample.nobs,
sample.mean = sample.mean,
sample.th = sample.th,
WLS.V = WLS.V,
NACOV = NACOV,
std.lv = TRUE,
orthogonal = TRUE,
estimator = estimator,
missing = missing,
parameterization = "delta",
se = "none",
test = "none")
unrotated <- lavaan::cfa(model = efa.mod,
sample.cov = sample.cov,
sample.nobs = sample.nobs,
sample.mean = sample.mean,
sample.th = sample.th,
WLS.V = WLS.V,
NACOV = NACOV,
std.lv = TRUE,
orthogonal = TRUE,
estimator = "DWLS",
missing = "pairwise",
parameterization = "delta",
se = "none",
test = "none")
loading <- GPArotation::GPFoblq(unrotated, method = "oblimin")$loadings
loading
loading <- GPArotation::GPFoblq(lavaan::lavInspect(unrotated, "est")$lambda, method = "oblimin")$loadings
loading
row.names(loading) <- paste0("v", 1:21)
loading
round(loading, 3)
round(loading[c(1,5,16:21)], 3)
round(loading[c(1,5,16:21),], 3)
short <- round(loading[c(1,5,16:21),], 3)
row.names(short) <- paste0("v", 1:8)
short
